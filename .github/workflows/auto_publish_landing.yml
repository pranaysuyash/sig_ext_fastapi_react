name: Auto Publish Landing (restricted)

on:
  push:
    branches:
      - landing-page

jobs:
  publish-landing:
    name: Auto publish landing to Cloudflare Pages (restricted)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout landing branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate required landing files exist
        run: |
          required=(index.html root.html buy.html purchase.html gum.html test-variants.html _redirects)
          for f in "${required[@]}"; do
            if [ ! -f "$f" ]; then
              echo "Missing required file: $f"; exit 1
            fi
          done
          # SEO files are strongly recommended (and expected for signkit.work)
          for f in robots.txt sitemap.xml 404.html; do
            if [ ! -f "$f" ]; then
              echo "Missing recommended file: $f"; exit 1
            fi
          done

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - name: Install Wrangler
        run: |
          npm install -g @cloudflare/wrangler

      - name: Run pre-publish checks (smoke tests + e2e)
        run: |
          nohup python3 serve.py &
          sleep 2
          ./test-pages.sh
          cd web/e2e && npm install --no-audit --no-fund
          npx playwright install --with-deps
          npm test

      - name: Publish to Cloudflare Pages
        env:
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          echo "Publishing landing-page branch to Cloudflare Pages (project: signkit-landing)"
          wrangler pages deploy . --project-name signkit-landing --branch landing-page

      - name: Done
        run: echo "Auto publish to Cloudflare Pages finished."
