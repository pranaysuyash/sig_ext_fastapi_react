name: Auto Publish Landing (restricted)

on:
  push:
    branches:
      - landing-page

jobs:
  publish-landing:
    name: Auto publish landing to Cloudflare Pages (restricted)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout landing branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate changed files are only landing assets
        run: |
          # Ensure we have origin/main fetched to diff against
          git fetch origin main:refs/remotes/origin/main
          # Ensure this push only modifies landing files; otherwise abort to avoid surprise publishes.
          changed_files=$(git diff --name-only origin/main...HEAD | tr '\n' ' ')
          echo "Changed files: $changed_files"
          if [ -z "$changed_files" ]; then
            echo "No changed files; nothing to publish"; exit 0
          fi
          for f in $changed_files; do
            case "$f" in
              # Landing HTML entrypoints
              index.html|root.html|buy.html|purchase.html|gum.html|new.html|test-variants.html)
                ;;
              # SEO / routing / deploy config
              robots.txt|sitemap.xml|404.html|_redirects|wrangler.toml|.cfignore|.pagesignore|.pages-include)
                ;;
              # Landing assets
              assets/*|css/*|js/*|screenshots/*|web/*)
                ;;
              # Landing-only CI workflow tuning
              .github/workflows/*)
                ;;
              *)
                echo "Detected changed file outside allowed paths: $f"; exit 1
                ;;
            esac
          done

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - name: Install Wrangler
        run: |
          npm install -g @cloudflare/wrangler

      - name: Run pre-publish checks (smoke tests + e2e)
        run: |
          nohup python3 serve.py &
          sleep 2
          ./test-pages.sh
          cd web/e2e && npm install --no-audit --no-fund
          npx playwright install --with-deps
          npm test

      - name: Publish to Cloudflare Pages
        env:
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          echo "Publishing landing-page branch to Cloudflare Pages (project: signkit-landing)"
          wrangler pages deploy . --project-name signkit-landing --branch landing-page

      - name: Done
        run: echo "Auto publish to Cloudflare Pages finished."
