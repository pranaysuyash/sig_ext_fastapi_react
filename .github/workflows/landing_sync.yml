name: Sync Landing Page to Main

on:
  push:
    branches:
      - landing-page
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  sync:
    name: Sync landing-page -> main
    runs-on: ubuntu-latest
    steps:
      - name: Checkout landing branch (trigger)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Save landing files
        run: |
          mkdir -p /tmp/landing-files
          # Copy web/live (variant canonical) if present
          if [ -d web/live ]; then
            rsync -a --delete web/live /tmp/landing-files/web/
          fi
          # Copy root-level variant pages
          for f in index.html buy.html purchase.html gum.html root.html; do
            if [ -f "$f" ]; then
              mkdir -p /tmp/landing-files
              cp "$f" /tmp/landing-files/
            fi
          done

      - name: Fetch main branch and create editing branch
        run: |
          git fetch origin main:refs/remotes/origin/main
          git checkout -b landing-sync-${{ github.sha }} origin/main

      - name: Copy landing files into main branch
        run: |
          # Replace web/live in main with the version from landing
          if [ -d /tmp/landing-files/web/live ]; then
            rm -rf web/live
            mkdir -p web/live
            rsync -a --delete /tmp/landing-files/web/live/ web/live/
          fi
          for f in index.html buy.html purchase.html gum.html root.html; do
            if [ -f /tmp/landing-files/$f ]; then
              cp /tmp/landing-files/$f $f
            fi
          done

      - name: Run smoke checks on copied landing files
        run: |
          echo "Running smoke checks on web/live and root pages..."
          # Check that the main landing folder and index.html exist
          if [ ! -d web/live ]; then
            echo "web/live folder missing"; exit 1;
          fi
          if [ ! -f web/live/index.html ]; then
            echo "web/live/index.html missing"; exit 1;
          fi
          # Ensure index contains a title tag
          if ! grep -q "<title" web/live/index.html; then
            echo "index.html missing <title>", exit 1;
          fi
          # Ensure sitemap and robots exist (optional; not required if site is dynamic)
          if [ -f web/live/sitemap.xml ]; then echo "sitemap.xml found"; fi
          if [ -f web/live/robots.txt ]; then echo "robots.txt found"; fi

      - name: Commit changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          if git diff --cached --quiet; then
            echo "No changes to sync -> exiting"
            exit 0
          fi
          git commit -m "chore(landing-sync): update web/live and root pages from landing-page"

      - name: Push updates to remote branch
        run: |
          git push origin HEAD:refs/heads/landing-sync-${{ github.sha }}

      - name: Create or update Pull Request to main
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'chore(landing-sync): update web/live and root pages from landing-page'
          title: 'chore(landing-sync): update web/live and root pages from landing-page'
          body: |
            Auto-generated PR: this updates the canonical `web/live` folder and the root-level landing pages (index.html, buy.html, purchase.html, gum.html, root.html) on `main` using the latest from `landing-page`.

            The action is triggered on pushes to `landing-page` and by manual workflow dispatch. Review CI and tests before merging.
          base: main
          branch: landing-sync-${{ github.sha }}
          labels: landing-sync
          reviewers: pranaysuyash
          assignees: pranaysuyash

      - name: Optionally automerge PR (requires repo admin and auto-merge enabled)
        if: false
        run: |
          echo "Auto-merge is disabled by default. To enable, change the workflow to set merge= true on create-pull-request or update this step."
