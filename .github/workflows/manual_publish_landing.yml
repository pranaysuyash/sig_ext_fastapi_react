name: Manual Pages Publish (landing)

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'The branch to publish from (defaults to landing-page)'
        required: false
        default: 'landing-page'
      publish_dir:
        description: 'Folder to publish (default: web/live, use . for full branch root)'
        required: false
        default: 'web/live'

jobs:
  publish-landing:
    name: Publish landing to Cloudflare Pages (manual)
    runs-on: ubuntu-latest
    steps:
      - name: Check out repo
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - name: Install Wrangler
        run: |
          npm install -g @cloudflare/wrangler

      - name: Prepare publish directory (copy root landing pages & assets)
        run: |
          mkdir -p web/live
          # Copy root-level HTML landing pages into web/live
          for f in index.html buy.html purchase.html gum.html root.html; do
            if [ -f "$f" ]; then cp "$f" web/live/; fi
          done
          # Copy entire root assets into web/live/assets if present
          if [ -d "assets" ]; then
            mkdir -p web/live/assets
            rsync -a --delete assets/ web/live/assets/
          fi
          # Copy screenshots if present at repo root
          if [ -d "screenshots" ]; then
            mkdir -p web/live/screenshots
            rsync -a --delete screenshots/ web/live/screenshots/
          fi
          # Copy landing page variant folders (e.g., web/claude_landing_page_v2) into web/live/web
          if [ -d "web/claude_landing_page_v2" ]; then
            mkdir -p web/live/web/claude_landing_page_v2
            rsync -a --delete web/claude_landing_page_v2/ web/live/web/claude_landing_page_v2/
          fi
      - name: Run pre-publish checks (smoke tests + e2e)
        run: |
            # Start server and run smoke tests
            nohup python3 serve.py &
            sleep 2
            ./test-pages.sh
            # Run e2e tests
            cd web/e2e && npm install --no-audit --no-fund
            npx playwright install --with-deps
            npm test
      

      - name: Ensure secrets are present
        env:
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          if [ -z "$CLOUDFLARE_ACCOUNT_ID" ] || [ -z "$CLOUDFLARE_API_TOKEN" ]; then
            echo "CLOUDFLARE_ACCOUNT_ID and CLOUDFLARE_API_TOKEN must be set in repository secrets";
            exit 1;
          fi

      - name: Configure auth
        env:
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          echo "Configuring Wrangler via env..."
          # Wrangler will pick up env vars via standard env

      - name: Publish web/live to Cloudflare Pages
        env:
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          # Publish the web/live folder to the signkit-pages-landing project
          wrangler pages publish "${{ github.event.inputs.publish_dir }}" --project-name signkit-pages-landing --branch "${{ github.event.inputs.branch }}"

      - name: Done
        run: echo "Cloudflare Pages publish finished."
