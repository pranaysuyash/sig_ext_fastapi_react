name: Manual Pages Publish (landing)

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'The branch to publish from (defaults to landing-page)'
        required: false
        default: 'landing-page'
      publish_dir:
        description: 'Folder to publish (default: ., publish full branch root)'
        required: false
        default: '.'

jobs:
  publish-landing:
    name: Publish landing to Cloudflare Pages (manual)
    runs-on: ubuntu-latest
    steps:
      - name: Check out repo
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - name: Install Wrangler
        run: |
          npm install -g @cloudflare/wrangler

      - name: Run pre-publish checks (smoke tests + e2e)
        run: |
          # Start server and run smoke tests
          nohup python3 serve.py &
          sleep 2
          ./test-pages.sh
          # Run e2e tests
          cd web/e2e && npm install --no-audit --no-fund
          npx playwright install --with-deps
          npm test

      - name: Ensure secrets are present
        env:
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          if [ -z "$CLOUDFLARE_ACCOUNT_ID" ] || [ -z "$CLOUDFLARE_API_TOKEN" ]; then
            echo "CLOUDFLARE_ACCOUNT_ID and CLOUDFLARE_API_TOKEN must be set in repository secrets";
            exit 1;
          fi

      - name: Configure auth
        env:
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          echo "Configuring Wrangler via env..."
          # Wrangler will pick up env vars via standard env

      - name: Publish to Cloudflare Pages
        env:
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          wrangler pages deploy "${{ github.event.inputs.publish_dir }}" --project-name signkit-landing --branch "${{ github.event.inputs.branch }}"

      - name: Done
        run: echo "Cloudflare Pages publish finished."
